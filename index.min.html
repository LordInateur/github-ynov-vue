<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>EzForm</title>
    <meta name="viewport" content="width=device-width, user-scalable=no">

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

  </head>
  <body>


    <div id="app">
      <!-- 
      <h1> {{ voiture.marque + " " + voiture.modele + " ( " + voiture.annee + " )" }}</h1>

      <form >
        <div><label>Marque : </label><input type="" name="marque" v-model="form.marque"></div>
        <div><label>Modele : </label><input type="" name="modele" v-model="form.modele"></div>
        <div><label>Annee : </label><input type="" name="annee" v-model="form.annee"></div>
      </form>
      
      <div> {{ form.marque + " " + form.modele + " ( " + form.annee + " )" }} </div>
      -->
      
      <h1>Application : </h1>
      <div><label>Min date : </label> <input type="date" name="" v-model="date.min"> <span> {{date.min}} </span></div>
      <div><label>Max date : </label> <input type="date" name="" v-model="date.max"> <span> {{date.min}} </span></div>
      <div><label>loadjson : </label> <textarea id="enfer" class="" style="height: 2em; width: 30em; vertical-align: top;">{{this.$data}}</textarea> <input type="button" name="" value="load Json" v-on:click="setData(document().getElementById('enfer').value)"></div>
      

      <div class="container">
        <div class="row">
          <div class="col-md-3">
            <div v-for="user in gitusers">
              <input type="checkbox" name="userSelected" v-model="userSelected" :value="user.pseudo" :id="user.pseudo" v-on:change="console().log(userSelected)">
              {{user.pseudo}}
              <div class="container">
                <div v-for="repo in user.repos" v-if="userSelected.indexOf(user.pseudo) >= 0">
                  <input type="checkbox" name="user.repoSelected" v-model="user.repoSelected" :value="repo" :id="repo" v-on:change="console().log(getRepoData(user.pseudo, repo))">
                  {{repo}}
                </div>
              </div>
             
            </div>
          </div>

          <div class="col-md-9">
            <div class="row">
              <div class="col-12" v-for="repo in getCommitsList">
                <img src="https://upload.wikimedia.org/wikipedia/commons/b/b1/Loading_icon.gif" style="height: 2em" v-if="repo.loading"> 
                <h2>{{ repo.title }} </h2>
                <div class="row" v-if="!repo.loading">
                  <div class="col-12" v-for="commit in repo.commits">
                    <div class="row">
                      <span class="col-2 d-none d-md-block">{{ commit.author.login }}</span>
                      <span class="col-7">{{ commit.commit.message }}</span>
                      <span class="col-3">{{ commit.commit.author.date }}</span>
                    </div>
        
                  </div>
                </div>


              </div>
            </div>

          </div>

        </div>
      </div>
    </div>  

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

    <!-- Vue.js -->
    <!-- development version, includes helpful console warnings -->
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <!-- production version, optimized for size and speed -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/vue"></script> -->

    <script type="text/javascript">
var app = new Vue({
  el: '#app',
  /*  data: {
    title: 'Titre : Une voiture',

    form : { 
      marque : "Mercedes",
      modele : "CLK",
      annee : 1995
    },
    voiture : {
      marque : "Mercedes",
      modele : "CLK",
      annee : 1995
    }
    

  }
  */
  created: function(){
    //created
  },
  mounted: function(){
    //
  },
  updated: function(){
    
  },
  destroyed: function(){

  },
  data: {
    date: {
      min : new Date().toJSON().slice(0,10), 
      max : new Date().toJSON().slice(0,10)
    },
    gitusers : [
      {pseudo : "LordInateur", repos : ["github-ynov-vue"], repoSelected:["github-ynov-vue"]},
      {pseudo : "benjaminbra", repos : ["github-ynov-vue"], repoSelected:["github-ynov-vue"]},
    ],
    userSelected : ["LordInateur"],
    commitsList : {}
  },
  methods: {
    console : function () {
      return console;
    }, 
    document : function(){
      return document;
    },
    getRepoData : function ( user, repo){
      // lordToken : f25f2cbf1b820c037516e027339beb37447775a4

      var myImage = document.querySelector('img');

      var myHeaders = new Headers();
      myHeaders.append('Authorization', 'token f25f2cbf1b820c037516e027339beb37447775a4');
      myHeaders.append('Accept', 'application/vnd.github.v3+json');

      var myInit = { method: 'GET',
                     headers: myHeaders,
                     mode: 'cors',
                     cache: 'default' };

      var myRequest = new Request(`https://api.github.com/repos/${user}/${repo}/commits`);

      var thus = this;

      fetch(myRequest,myInit).then(function(response) {
         return response.json().then(function(json) {
          thus.commitsList[`${user}/${repo}`].commits = json;
          thus.commitsList[`${user}/${repo}`].loading = false;
          thus.$forceUpdate();
        });
      })
      
    },
    getData(){
      return this.$data
    },
    setData(data){
      Object.assign(this.$data, JSON.parse(data))
    }
  },
  computed: {
    listOfRepo : function(){
      return this.gitusers.reduce((acc, value)=>{
        console.log(value.repoSelected)
        for ( repo in value.repoSelected){
          acc.push(`${value.pseudo}/${value.repoSelected[repo]}`)
          let title = `${value.pseudo}/${value.repoSelected[repo]}`;
          if(this.commitsList[title] == undefined){
            this.commitsList[title] = { 'title': title, loading : true }
            this.getRepoData(value.pseudo, value.repoSelected[repo])
          }
        }
        console.log(this.commitsList)
        return acc
      }, [])
    },

    getCommitsList : function(){
      this.listOfRepo ;
      // TODO : ajouter pour supprimer les objects qui ne sont pas dans listOfRepo
      return this.commitsList;
    }

  }
})
      

      
    </script>
  </body>

</html>